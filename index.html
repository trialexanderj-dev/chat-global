<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat Global Mejorado</title>
<style>
  body { font-family: Arial, sans-serif; background:#1e1e1e; color:#fff; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
  #login { padding:20px; text-align:center; }
  #username { padding:8px; width:200px; }
  #chatBox { display:flex; flex-direction:column; height:100%; }
  #chat { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:5px; }
  .message { max-width:70%; padding:8px 12px; border-radius:15px; word-wrap:break-word; }
  .own { background:#0b93f6; align-self:flex-end; color:#fff; }
  .other { background:#2c2c2c; align-self:flex-start; color:#fff; }
  .time { font-size:0.7em; opacity:0.7; margin-left:5px; }
  #inputBox { display:flex; padding:10px; gap:5px; border-top:1px solid #444; }
  #message { flex:1; padding:8px; border-radius:5px; border:none; }
  #send { padding:8px 12px; border:none; border-radius:5px; background:#0b93f6; color:#fff; cursor:pointer; }
  #users { padding:5px 10px; border-bottom:1px solid #444; background:#2c2c2c; font-size:0.9em; }
</style>
</head>
<body>

<div id="login">
  <input id="username" placeholder="Escribe tu nombre de usuario">
  <button onclick="login()">Entrar al chat</button>
</div>

<div id="chatBox" style="display:none;">
  <div id="users">Usuarios conectados: <span id="userList">0</span></div>
  <div id="chat"></div>
  <div id="inputBox">
    <input id="message" placeholder="Escribe un mensaje" onkeypress="enterPress(event)">
    <button id="send" onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ðŸ”¹ ConfiguraciÃ³n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAXMMWNEtbqipdYFrQ6Lu5Kkf9XK2rD6qs",
  authDomain: "global-chat-c1ecf.firebaseapp.com",
  databaseURL: "https://global-chat-c1ecf-default-rtdb.firebaseio.com",
  projectId: "global-chat-c1ecf",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const messagesRef = ref(db, "messages");
const usersRef = ref(db, "users");

let user = "";

// ðŸ”¹ Login
window.login = function() {
  const input = document.getElementById("username");
  if(input.value.trim()==="") return alert("Escribe un nombre");
  user = input.value.trim();
  document.getElementById("login").style.display="none";
  document.getElementById("chatBox").style.display="flex";

  // AÃ±adir usuario a la lista
  push(usersRef, { name: user });
}

// ðŸ”¹ Enviar mensaje
window.sendMessage = function() {
  const msg = document.getElementById("message").value.trim();
  if(msg==="") return;
  const now = new Date();
  const time = now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");
  push(messagesRef, { user, text: msg, time });
  document.getElementById("message").value="";
}

// ðŸ”¹ Enviar con Enter
window.enterPress = function(e) {
  if(e.key === "Enter") sendMessage();
}

// ðŸ”¹ Escuchar mensajes
onChildAdded(messagesRef, (data) => {
  const { user: u, text, time } = data.val();
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "message " + (u===user ? "own":"other");
  div.innerHTML = `<b>${u}:</b> ${text} <span class="time">${time}</span>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
});

// ðŸ”¹ Actualizar lista de usuarios conectados
onValue(usersRef, (snapshot) => {
  const users = snapshot.val();
  const list = users ? Object.values(users).map(u=>u.name) : [];
  document.getElementById("userList").textContent = list.join(", ") || "0";
});
</script>

</body>
</html>
